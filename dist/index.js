'use strict';var _promise=require('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _assign=require('babel-runtime/core-js/object/assign');var _assign2=_interopRequireDefault(_assign);var _regenerator=require('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);var _getPrototypeOf=require('babel-runtime/core-js/object/get-prototype-of');var _getPrototypeOf2=_interopRequireDefault(_getPrototypeOf);var _classCallCheck2=require('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _possibleConstructorReturn2=require('babel-runtime/helpers/possibleConstructorReturn');var _possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2);var _inherits2=require('babel-runtime/helpers/inherits');var _inherits3=_interopRequireDefault(_inherits2);var _sharp=require('sharp');var _sharp2=_interopRequireDefault(_sharp);var _request=require('request');var _request2=_interopRequireDefault(_request);var _nodeSchedule=require('node-schedule');var _nodeSchedule2=_interopRequireDefault(_nodeSchedule);var _events=require('events');var _events2=_interopRequireDefault(_events);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var ThisPersonDoesNotExist=function(_EventEmitter){(0,_inherits3.default)(ThisPersonDoesNotExist,_EventEmitter);function ThisPersonDoesNotExist(options){(0,_classCallCheck3.default)(this,ThisPersonDoesNotExist);var _this=(0,_possibleConstructorReturn3.default)(this,(ThisPersonDoesNotExist.__proto__||(0,_getPrototypeOf2.default)(ThisPersonDoesNotExist)).call(this));_this.options={};return _this;}(0,_createClass3.default)(ThisPersonDoesNotExist,[{key:'getBase64',value:function(){var _ref=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(body,mimType,width,height){var resizedImageBuffer,resizedImageData,resizedBase64;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return(0,_sharp2.default)(body).resize(width,height).toBuffer();case 2:resizedImageBuffer=_context.sent;resizedImageData=resizedImageBuffer.toString('base64');resizedBase64='data:'+mimType+';base64,'+resizedImageData;return _context.abrupt('return',resizedBase64);case 6:case'end':return _context.stop();}}},_callee,this);}));function getBase64(_x,_x2,_x3,_x4){return _ref.apply(this,arguments);}return getBase64;}()},{key:'getImagePath',value:function(){var _ref2=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(body,path,width,height){var name,ImagePath;return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:name=this.getId(10)+'.jpeg';_context2.next=3;return(0,_sharp2.default)(body).resize(width,height).toFile(path+'/'+name);case 3:ImagePath=_context2.sent;return _context2.abrupt('return',(0,_assign2.default)(ImagePath,{name:name}));case 5:case'end':return _context2.stop();}}},_callee2,this);}));function getImagePath(_x5,_x6,_x7,_x8){return _ref2.apply(this,arguments);}return getImagePath;}()},{key:'getRemoteImage',value:function(){var _ref3=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3(){return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:return _context3.abrupt('return',new _promise2.default(function(resolve,reject){_request2.default.get({url:'https://thispersondoesnotexist.com/image',encoding:null},function(error,response,body){if(error)return reject(error);try{if(response.statusCode==200){var img=new Buffer(body,'base64');var mimType=response.headers["content-type"];resolve({img:img,mimType:mimType});}else{throw error;}}catch(e){reject(e);}});}));case 1:case'end':return _context3.stop();}}},_callee3,this);}));function getRemoteImage(){return _ref3.apply(this,arguments);}return getRemoteImage;}()},{key:'getImage',value:function(){var _ref4=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4(_ref5){var width=_ref5.width,height=_ref5.height,type=_ref5.type,path=_ref5.path;var _ref6,img,mimType,response;return _regenerator2.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:width=width||256;height=height||256;type=type||'file';path=path||'.';_context4.prev=4;_context4.next=7;return this.getRemoteImage();case 7:_ref6=_context4.sent;img=_ref6.img;mimType=_ref6.mimType;if(!(img&&mimType)){_context4.next=27;break;}response=void 0;_context4.t0=type;_context4.next=_context4.t0==='base64'?15:_context4.t0==='file'?19:23;break;case 15:_context4.next=17;return this.getBase64(img,mimType,width,height);case 17:response=_context4.sent;return _context4.abrupt('break',24);case 19:_context4.next=21;return this.getImagePath(img,path,width,height);case 21:response=_context4.sent;return _context4.abrupt('break',24);case 23:return _context4.abrupt('break',24);case 24:return _context4.abrupt('return',{status:true,data:response});case 27:throw error;case 28:_context4.next=33;break;case 30:_context4.prev=30;_context4.t1=_context4['catch'](4);throw _context4.t1;case 33:case'end':return _context4.stop();}}},_callee4,this,[[4,30]]);}));function getImage(_x9){return _ref4.apply(this,arguments);}return getImage;}()},{key:'cron',value:function cron(_ref7){var _this2=this;var time=_ref7.time,width=_ref7.width,height=_ref7.height,type=_ref7.type,path=_ref7.path;_nodeSchedule2.default.scheduleJob(time,(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee5(){var res;return _regenerator2.default.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return _this2.getImage({width:width,height:height,type:type,path:path});case 2:res=_context5.sent;_this2.emit('created',res);case 4:case'end':return _context5.stop();}}},_callee5,_this2);})));}},{key:'getId',value:function getId(length){var text="";var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<length;i++){text+=possible.charAt(Math.floor(Math.random()*possible.length));}return text;}}]);return ThisPersonDoesNotExist;}(_events2.default);module.exports=ThisPersonDoesNotExist;